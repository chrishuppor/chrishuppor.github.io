---
layout: post
title: "微博超话签到"
pubtime: 2021-05-08
updatetime: 2021-05-08
categories: Program
tags: Python
---

批量进行微博超话签到。

# 2021-05-08-微博超话签到

* 原理：使用chrome的网页测试功能，通过chromedriver.exe模拟对签到按钮的点击
* 流程：首先登录账号，然后解除异常，最后进行签到。其中，登录时需要人工进行验证，且每个账号每天验证次数有限；第一次尝试签到时会触发异常，需要人工解除。

```
from selenium import webdriver
from selenium.webdriver.common.keys import Keys
import time

#1. 登录：需要手工验证
def CheckIn(username, password, chromedriver_addr):
  #读取微博账号密码
  wd = webdriver.Chrome(chromedriver_addr)#chromedriver的地址
  wd.implicitly_wait(3) #每隔半秒钟再次执行可能抛出异常的代码，规避time.sleep()的万一情况
  wd.set_window_size(452, 790)
  wd.get("https://passport.weibo.cn/signin/login")
  elem = wd.find_element_by_xpath("//*[@id='loginName']");
  elem.send_keys(username)
  elem = wd.find_element_by_xpath("//*[@id='loginPassword']");
  elem.send_keys(password)
  elem = wd.find_element_by_xpath("//*[@id='loginAction']");
  elem.send_keys(Keys.ENTER) #等待3秒看登录的账号密码是否正确
  input("是否输入验证码:(输入任意内容继续)")

#2. 触发警告：在第一次点击签到时会有 账号操作异常 警告，所以需要先触发一次
# test_url: 超话链接
def PassWarning(test_url):
  wd.get(test_url)
  time.sleep(30) #这里要等待几秒中，等待网页加载完全，否则点击签到无效
  try:
    print ('触发异常警告')
    xpathstr = '//*[@class="opt_box clearfix"]/div[3]' #表示class="opt_box clearfix"下第三个div  
    wd.find_element_by_xpath(xpathstr).click()
    time.sleep(2)
  except Exception as e:
    print("[-]ERR 签到", e)


def CheckTime(tss1):
  #转换标准时间到时间戳
  timeArray = time.strptime(tss1, "%Y-%m-%d %H:%M:%S")
  clicktime = int(time.mktime(timeArray))
  #https://tool.lu/timestamp/ 时间戳转换工具

  now = time.time()
  while now < clicktime:
    now = time.time()
    time.sleep(0.1)

#3. 正式签到
# main_address_list: 超话主页链接列表
# checktimestr: 开始签到时间'2021-5-8 11:40:00'
def SignIn(main_address_list, checktimestr):
  for main_address in main_address_list:
    wd.get(main_address)
    time.sleep(10) #这里要等待几秒中，等待网页加载完全，否则点击签到无效
    try:
      print ('点击签到')
      #这里是签到按钮的元素，如果有问题，查一查find_element_by_xpath
      xpathstr = '//*[@class="opt_box clearfix"]/div[3]' #表示class="opt_box clearfix"下第三个div  
      CheckTime(checktimestr)
      wd.find_element_by_xpath(xpathstr).click()
      time.sleep(2)
    except Exception as e:
      print("[-]ERR 签到", e)

    try:
      elem = wd.find_element_by_xpath('//*[@class="point clearfix"]/dd/div')
      print(elem.text)
      sign_num = elem.text #获取的超话签到数
    except Exception as e:
      print("[-]ERR 获取签到人数", e)

#----------------------------------------------------------------------------------------
#读取地址
main_address_list = [
  "https://weibo.com/p/100808e17af551a911967784d8256c9f81a0db/super_index",
  "https://weibo.com/p/1008088d56bf26ec2dece683f0fa7061b46749/super_index"]


username = "0000"
password = "0000"
chromedriver_addr = 'e:/python37/chromedriver.exe'
checktimestr = '2021-5-8 11:40:00'
test_url = main_address_list[0]

CheckIn(username, password, chromedriver_addr)
PassWarning(test_url)
SignIn(main_address_list, checktimestr)
```
